{ "version": 3, "file": "lua/ormery/tests/sql-test.lua", "sources": [ "-work/src/sql/tests.temper.md" ], "sourcesContent": [ "# SqlBuilder tests\n\n## String escaping\n\nTODO Test for all dialects together?\n\n    test(\u0022string escaping\u0022) {\n      let build(name: String): String {\n        sql\u0022select * from hi where name = \u0024{name}\u0022.toString()\n      }\n      let buildWrong(name: String): String {\n        \u0022select * from hi where name = '\u0024{name}'\u0022\n      }\n\nTry an easy case and also little Bobby.\n\n      assert(build(\u0022world\u0022) == \u0022select * from hi where name = 'world'\u0022);\n      let bobbyTables = \u0022Robert'); drop table hi;--\u0022;\n      assert(\n        build(bobbyTables) ==\n          \u0022select * from hi where name = 'Robert''); drop table hi;--'\u0022\n      );\n\nAlso show why we care with a failed case.\n\n      assert(\n        buildWrong(bobbyTables) ==\n          \u0022select * from hi where name = 'Robert'); drop table hi;--'\u0022\n      );\n    }\n\n## String edge cases\n\nWe don't parse the SQL itself, so we can test subexpressions without worrying\ncontext.\n\nNote that we don't have the ability to compose SQL syntax itself in these\ntemplates.\n\n    test(\u0022string edge cases\u0022) {\n      assert(sql\u0022v = \u0024{\u0022\u0022}\u0022.toString() == \u0022v = ''\u0022);\n      assert(sql\u0022v = \u0024{\u0022a''b\u0022}\u0022.toString() == \u0022v = 'a''''b'\u0022);\n      assert(sql\u0022v = \u0024{\u0022Hello 世界\u0022}\u0022.toString() == \u0022v = 'Hello 世界'\u0022);\n\nTODO Which databases allow for multiline strings? Seems sqlite does:\n\n```sql\nsqlite\u003e select 'line 1\n'  ...\u003e line 2';\nline 1\nline 2\nsqlite\u003e\n```\n\n      assert(sql\u0022v = \u0024{\u0022Line1\\nLine2\u0022}\u0022.toString() == \u0022v = 'Line1\\nLine2'\u0022);\n    }\n\n## Numbers and Booleans\n\n    test(\u0022numbers and booleans\u0022) {\n      assert(\n        sql\u0022select \u0024{42}, \u0024{43i64}, \u0024{19.99}, \u0024{true}, \u0024{false}\u0022.toString() ==\n          \u0022select 42, 43, 19.99, TRUE, FALSE\u0022\n      );\n      let date = new Date(2024, 12, 25) orelse panic();\n      assert(\n        sql\u0022insert into t values (\u0024{date})\u0022.toString() ==\n          \u0022insert into t values ('2024-12-25')\u0022\n      );\n    }\n\n## Lists\n\nLists go in comma-separated, with each element escaped as appropriate.\n\nTODO If contextual, we could put parens around automatically when needed.\n\n    test(\u0022lists\u0022) {\n      assert(\n        sql\u0022v IN (\u0024{[\u0022a\u0022, \u0022b\u0022, \u0022c'd\u0022]})\u0022.toString() == \u0022v IN ('a', 'b', 'c''d')\u0022\n      );\n      assert(sql\u0022v IN (\u0024{[1, 2, 3]})\u0022.toString() == \u0022v IN (1, 2, 3)\u0022);\n      assert(sql\u0022v IN (\u0024{[1i64, 2i64]})\u0022.toString() == \u0022v IN (1, 2)\u0022);\n      assert(sql\u0022v IN (\u0024{[1.0, 2.0]})\u0022.toString() == \u0022v IN (1.0, 2.0)\u0022);\n      assert(sql\u0022v IN (\u0024{[true, false]})\u0022.toString() == \u0022v IN (TRUE, FALSE)\u0022);\n      let dates = [\n        new Date(2024, 1, 1) orelse panic(),\n        new Date(2024, 12, 25) orelse panic(),\n      ];\n      assert(\n        sql\u0022v IN (\u0024{dates})\u0022.toString() == \u0022v IN ('2024-01-01', '2024-12-25')\u0022\n      );\n    }\n\n## Nesting\n\nPut already escaped SQL into another SQL fragment.\n\n    test(\u0022nesting\u0022) {\n      let name = \u0022Someone\u0022;\n      let condition = sql\u0022where p.last_name = \u0024{name}\u0022;\n\nFirst check adding expanded semi-structured fragment content.\n\n      assert(\n        sql\u0022select p.id from person p \u0024{condition}\u0022.toString() ==\n          \u0022select p.id from person p where p.last_name = 'Someone'\u0022\n      );\n\nAlso check adding content frozen to SQL source.\n\n      assert(\n        sql\u0022select p.id from person p \u0024{condition.toSource()}\u0022.toString() ==\n          \u0022select p.id from person p where p.last_name = 'Someone'\u0022\n      );\n\nWe can also append individual parts.\n\n      let parts: List\u003cSqlPart\u003e = [new SqlString(\u0022a'b\u0022), new SqlInt32(3)];\n      assert(sql\u0022select \u0024{parts}\u0022.toString() == \u0022select 'a''b', 3\u0022);\n    }\n" ], "names": [], "mappings": "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" }